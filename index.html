<html>

<head>
    <title>EduSync</title>

    <!--CDN link for Vue.js-->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>

    <!--Link to your local JavaScript file-->
    <!-- <script src="products.js"></script> -->

    <!--Link to your local CSS file-->
    <link rel="stylesheet" type="text/css" href="style.css">

    <!--CDN link for font awesome-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">

    <!--CDN link for Bootstrap CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

</head>


<body>
    
    <!-- Vue app container -->
    <div id="app">

        <!-- Navigation section -->
        <div class="navigationContainer">

            <!-- Logo and cart icon in the navigation bar -->
            <ul class="navbar">
                <li>
                    <a class="logo">
                        <img src="images/eduSync_logo.png" alt="Logo">
                    </a>
                </li>

                <li style="float:right">
                    <a button v-on:click="showCheckout">

                        <!-- Cart icon and item count -->
                        {{ cartItemCount }}
                        <span class="fas fa-cart-plus"></span>
                        Checkout
                        </button>
                    </a>
                </li>
            </ul>

            <!-- Category selection and sorting options -->
            <ul class="categoryNavbar">

                <!-- Search bar and category links -->
                <li style="padding-left: 1%">
                    <input v-model.trim="searchQuery" type="search" class="searchbar" id="searchbar"
                        placeholder="Search Courses & Activites">
                </li>
                <li>
                    <a @click="selectCategory('all')">All Products</a>
                </li>
                <li>
                    <a @click="selectCategory('coreSubjects')">Core Courses</a>
                </li>
                <li>
                    <a @click="selectCategory('extracurricularActivities')">Extracurricular Activities</a>
                </li>

                <!-- Sorting options -->
                <li style="float:right">
                    <a>
                        <div class="sortContainer">
                            <label for="sortAttribute">Sort by:</label>
                            <select v-model="sortAttribute" id="sortAttribute">
                                <option value="title">Subject</option>
                                <option value="location">Location</option>
                                <option value="price">Price</option>
                                <option value="availableInventory">Spaces</option>
                            </select>

                            <label for="sortOrder">Order:</label>
                            <select v-model="sortOrder" id="sortOrder">
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                    </a>
                </li>
            </ul>
        </div>

        <main>
            <div id="products-section">
                <!-- Product display section -->
                <div v-if="showProduct" style="overflow: scroll;display: flex; width: 100%;">

                    <!-- Display individual products with details -->
                    <div class="product" v-for="product in sortedAndFilteredProducts">

                        <!-- Product details -->
                        <figure>
                            <img v-bind:src="product.image" width="250" height="250">
                        </figure>
                        <h2 v-text="product.title"></h2>
                        <p v-html="product.description"></p>
                        <p>Location: {{ product.location }}</p>
                        <p>Price: {{product.price}} AED</p>
                        <p>
                            Inventory: {{product.availableInventory - cartCount(product.id)}}
                        </p>

                        <!-- Add to cart and remove from cart buttons -->
                        <button v-on:click="addToCart(product)" v-if="canAddToCart(product)">
                            Add to cart
                        </button>
                        <button v-on:click="removeFromCart(product)" v-if="canRemoveFromCart(product)">
                            Remove from Cart
                        </button>
                        <button disabled="disabled" v-else>
                            N/A
                        </button>

                        <!-- Inventory status messages -->
                        <span v-if="product.availableInventory === cartCount(product.id)">
                            All Out!
                        </span>
                        <span v-else-if="product.availableInventory - cartCount(product.id) < 5">
                            only {{product.availableInventory -
                            cartCount(product.id)}} Left!!
                        </span>
                        <span v-else>
                            BUY NOW!!
                        </span>

                        <!-- Product rating stars -->
                        <div>
                            <span v-for="n in product.rating" class="star">★</span>
                            <span v-for="n in 5 - product.rating" class="star">☆</span>
                        </div>
                    </div>
                </div>


                <!-- Checkout and Cart display section -->
                <div v-else>
                    <div class="checkout-container">

                        <!-- Checkout form -->
                        <h2>Checkout</h2>

                        <!-- Input fields for user details -->
                        <p>
                            <strong>First Name:</strong>
                            <input v-model.trim="order.firstName" required>
                        </p>
                        <p>
                            <strong>Last Name:</strong>
                            <input v-model.trim="order.lastName" required>
                        </p>
                        <p>
                            <strong>Address:</strong>
                            <input v-model="order.address" required>
                        </p>
                        <p>
                            <strong>City:</strong>
                            <input v-model="order.city" required>
                        </p>
                        <p>
                            <strong>Province:</strong>
                            <select v-model="order.province" required>
                                <option disabled value>Province</option>
                                <option v-for="(province, key) in provinces" :key="key" :value="province">{{ key }}
                                </option>
                            </select>
                        </p>
                        <p>
                            <strong>Zip/Postal Code:</strong>
                            <input v-model.number="order.zip" type="number" required>
                        </p>
                        <p>
                            <strong>Email (Gmail):</strong>
                            <input v-model.trim="order.email" required pattern="^[a-zA-Z0-9._%+-]+@gmail.com$"
                                title="Enter a valid Gmail address">
                        </p>
                        <p>
                            <input type="checkbox" id="gift" value="true" v-model="order.gift"
                                :true-value="order.sendGift" :false-value="order.dontSendGift">
                            <label for="gift"> Ship As Gift?</label>
                        </p>
                        <p>
                            <input type="radio" id="home" value="Home" v-model="order.method" required>
                            <label for="home"> Home</label>
                            <input type="radio" id="business" value="Business" v-model="order.method" required>
                            <label for="business"> Business</label>
                        </p>

                        <button @click="validateAndSubmit">Place Order</button>
                    </div>
                </div>

                <div class="checkout-container">
                    <!-- Display Products in Cart -->
                    <div class="cart-container">
                        <h2>Shopping Cart</h2>
                        <!-- Cart content display -->
                        <div v-if="cart.length === 0">
                            <p>Your cart is empty.</p>
                        </div>
                        <div v-else>
                            <div v-for="(productId, index) in uniqueCartItems" :key="index">
                                <div class="cart-item">
                                    <h3>
                                        {{ getProductById(productId).title }}
                                        (x{{ cartCount(productId) }})
                                    </h3>
                                    <img :src="getProductById(productId).image" alt="Product Image" width="100"
                                        height="100">
                                    <p>Price: {{ getProductById(productId).price }}</p>
                                    <p>{{ getProductById(productId).description }}</p>

                                    
                                    <button @click="removeFromCart(getProductById(productId))">Remove</button>
                                    <button @click="addToCart(getProductById(productId))">Add</button>
                                    <br><br>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Buttons to navigate or submit order -->
                    <button @click="navigateToProducts">Add items to cart</button>
                    <button @click="validateAndSubmit">Place Order</button>

                </div>
            </div>
        </main>
    </div>

    <!-- Vue.js script -->
    <script type="text/javascript">

        // Vue instance for the EduSync web application
        let webstore = new Vue({
            el: '#app',

            // Data properties for storing application state
            data: {
                // Site name mounting the app
                sitename: 'EduSync',
                showProduct: true,
                // Contains an array of lesson data
                products: [],
                // Array to store items in the cart
                cart: [],
                // Attribute to sort products by (default: title of Subject)
                sortAttribute: "title",
                sortOrder: "asc",
                // Order information (first name last name, address, email)
                order: {
                    firstName: '',
                    lastName: '',
                    address: '',
                    email: '',
                },

                provinces: {
                    AB: 'Alberta',
                    SK: 'Saskachewan',
                    BC: 'British Columbia',
                    ON: 'Ontario'
                },


                // products: products,
                searchQuery: '',
                
                // selectedSortOrder: 'lowToHigh'
            },

created: function () {
    fetch('http://localhost:3000/collection/lessons', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error('Network response was not ok');
        }
        return res.json();
    })
    .then(data => {
        this.products = data; // Assign the fetched data to the products array
    })
    .catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
    });
},


            // Methods for handling user interactions and form submission
            methods: {
                addToCart(product) {
                    this.cart.push(product.id);
                },

                removeFromCart(product) {
                    const index = this.cart.indexOf(product.id);
                    if (index !== -1) {
                        this.cart.splice(index, 1);
                    }
                },

                showCheckout() {
                    this.showProduct = this.showProduct ? false : true;
                },

                canAddToCart(product) {
                    return product.availableInventory > this.cartCount(product.id);
                },

                canRemoveFromCart(product) {
                    return product.availableInventory > this.cartCount(product.id);
                },

                cartCount(productId) {
                    return this.cart.filter(id => id === productId).length;
                },

                removeFromCart(product) {
                    const index = this.cart.indexOf(product.id);
                    if (index !== -1) {
                        this.cart.splice(index, 1);
                    }
                },

                getProductById(productId) {
                    return this.products.find(product => product.id === productId);
                },

                submitForm() {
    alert('Order Submitted!');
    postOrder(this.order.fullName, this.order.phone, this.cart);

    function postOrder(name, contact, orderCart) {
        var finalCart = []; //...new Array for cart items
    
        for (let i =  0; i < orderCart.length; i++) {
            const uniqueCartOrder = { "_id": orderCart[i]._id, "lesson": orderCart[i].name, "quantity":  1 };  
        
            //...for loop to change quantity of each UNIQUE item  
            let found = false;
            for (let j =  0; j < finalCart.length; j++) {
                if (finalCart[j]._id == orderCart[i]._id) { //... if item already exists in finalCart Array
                    found = true;
                    finalCart[j].quantity++; //...increases quantity
                    break;
                }
            }
            //...adds new item to cart
            if (!found) {
                finalCart.push(uniqueCartOrder);
            }
        }
        console.log(finalCart);
        const newOrder = { "order": finalCart, "name": name, "contact": contact }; //...creates JSON object for fetch POST request
        fetch('http://cst3145-cw2-env.eba-qvjju2fi.eu-west-2.elasticbeanstalk.com/collection/orders', {
            method: 'POST', // set the HTTP method as 'POST'
            headers: {
                'Content-Type': 'application/json', // set the data type as JSON
            },
            body: JSON.stringify(newOrder), // need to stringify the JSON object
        })
        .then(response => response.json()) // Parse response as JSON
        .then(function () {
            //...loop through finalCart array to update the availability of lessons
            for (let i =  0; i < finalCart.length; i++) {
                //...fetch PUT to update the availability
                fetch("http://cst3145-cw2-env.eba-qvjju2fi.eu-west-2.elasticbeanstalk.com/collection/lessons/" + finalCart[i]._id, {
                    method: 'PUT',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ "availability": lessons[i].availability - finalCart[i].quantity }), //...Subtracts cart quantity from lessons availability
                })
                .then(response => response.json()) // Parse response as JSON
                .then(data => {
                    console.log(data); // Log response from PUT request
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            
                console.log("Lessons array: ", lessons[i]);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    
        // clears the shopping cart, indicating that the order has been successfully submitted  
        this.cart = [];
        //clears the user's input for full name and phone number after the order has been submitted.
        this.order = {
            fullName: '',
            phone: '',
        };
    }
},


                validateAndSubmit() {
                    if (
                        this.order.firstName &&
                        this.order.lastName &&
                        this.order.address &&
                        this.order.city &&
                        this.order.province &&
                        this.order.zip &&
                        this.order.method &&
                        this.order.email
                    ) {
                        if (this.order.email.match(/^[a-zA-Z0-9._%+-]+@gmail\.com$/)) {
                            // All required fields are filled, and email is a valid Gmail address
                            this.submitForm();
                        } else {
                            alert('Please enter a valid Gmail address.');
                        }
                    } else {
                        alert('Please fill in all required fields.');
                    }
                },

                selectCategory(category) {
                    this.selectedSortOrder = 'default'; // Reset sorting order
                    this.searchQuery = ''; // Reset search query

                    switch (category) {
                        case 'all':
                            this.showProduct = true;
                            break;
                        case 'coreSubjects':
                            this.showProduct = false;
                            break;
                        case 'extracurricularActivities':
                            this.showProduct = false;
                            break;
                        // Add more cases for additional categories
                        default:
                            break;
                    }
                },

                navigateToProducts() {
                    // Reset the view to show the product page
                    this.showProduct = true;

                    const productsSection = document.getElementById('products-section');
                    if (productsSection) {
                        productsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                },

            },

            // Computed properties for dynamic data calculations
            computed: { // the Computed Property object
                cartItemCount: function () { //the property name
                    // its value is calculated when it is called
                    return this.cart.length || '';
                },

                coreSubjects() {
                    return this.sortedAndFilteredProducts.filter(product => {
                        return product.description.toLowerCase().includes('core subject');
                    });
                },

                extracurricularActivities() {
                    return this.sortedAndFilteredProducts.filter(product => {
                        return product.description.toLowerCase().includes('extracurricular activity');
                    });
                },



                uniqueCartItems() {
                    // Create a set of unique product IDs in the cart
                    const uniqueProductIds = new Set(this.cart);

                    // Convert the set back to an array
                    return Array.from(uniqueProductIds);
                },

                sortedAndFilteredProducts() {
                    let productsArray = [...this.products];

                    // Filter based on the searchQuery
                    const query = this.searchQuery.toLowerCase();
                    productsArray = productsArray.filter(product => {
                        return (
                            product.title.toLowerCase().includes(query) ||
                            product.description.toLowerCase().includes(query)
                        );
                    });

                    // Sort based on the selectedSortOrder
                    switch (this.selectedSortOrder) {
                        case 'lowToHigh':
                            productsArray.sort((a, b) => a.price - b.price);
                            break;
                        case 'highToLow':
                            productsArray.sort((a, b) => b.price - a.price);
                            break;
                        case 'location':
                            productsArray.sort((a, b) => a.location.localeCompare(b.location));
                            break;
                        case 'spacesAvailability':
                            productsArray.sort((a, b) => a.availableInventory - b.availableInventory);
                            break;
                        // Add more cases for additional sorting options
                        default:
                            break;
                    }

                    return productsArray;
                },



            }
        });
    </script>
</body>

</html>